<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JScanify — Simple Document Scanner</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#22c55e;--muted:#94a3b8;color-scheme:light}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Arial;background:linear-gradient(180deg,#081124 0%, #071028 100%);color:#e6eef8}
    .container{max-width:980px;margin:28px auto;padding:22px;background:rgba(255,255,255,0.03);border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 12px;font-size:20px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    button,input[type=file]{background:transparent;border:1px solid rgba(255,255,255,0.07);padding:8px 12px;border-radius:8px;color:inherit;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#16a34a);color:#032;box-shadow:0 6px 18px rgba(34,197,94,0.12);border:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;min-height:260px;display:flex;flex-direction:column;align-items:center;justify-content:center}
    video,canvas,img{max-width:100%;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.5)}
    footer{margin-top:12px;font-size:13px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .result-actions{display:flex;gap:8px;margin-top:8px}
    @media (max-width:780px){.row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <h1>JScanify — Simple Document Scanner</h1>
    <div class="controls">
      <button id="openCamera">Open Camera</button>
      <button id="capture" disabled>Capture</button>
      <label>
        <input id="fileInput" type="file" accept="image/*" style="display:none">
        <button id="uploadBtn">Upload Image</button>
      </label>
      <button id="processBtn" class="primary" disabled>Process (Extract Paper)</button>
      <button id="downloadBtn" disabled>Download Result</button>
      <button id="resetBtn">Reset</button>
    </div>

    <div class="row">
      <div class="panel">
        <strong>Camera / Source</strong>
        <div style="width:100%;margin-top:8px;display:flex;gap:8px;align-items:flex-start;">
          <video id="video" playsinline autoplay style="width:100%;height:240px;background:#000;border-radius:8px;object-fit:cover;display:none"></video>
          <img id="sourcePreview" alt="source preview" style="display:none;max-height:240px;object-fit:contain">
        </div>
        <div class="flex" style="margin-top:10px">
          <small id="sourceInfo">No source selected</small>
        </div>
      </div>

      <div class="panel">
        <strong>Result</strong>
        <div id="resultWrap" style="width:100%;margin-top:8px;display:flex;flex-direction:column;align-items:center;">
          <!-- result canvas will be appended here -->
          <div id="resultPlaceholder" style="color:var(--muted);">No result yet</div>
        </div>
      </div>
    </div>

    <footer>
      <div>Uses OpenCV.js and jscanify. Make sure both script files are accessible from your network.</div>
      <div style="margin-top:6px">Tip: For best results, capture the paper on a contrasting background and avoid heavy shadows.</div>
    </footer>
  </div>

  <!-- External dependencies (you provided these)-->
  <script src="https://docs.opencv.org/4.7.0/opencv.js" async></script>
  <script src="https://cdn.jsdelivr.net/gh/ColonelParrot/jscanify@master/src/jscanify.min.js"></script>

  <script>
    // Simple page-level scanner UI glue code for jscanify
    let videoStream = null;
    let currentImage = null; // HTMLImageElement of the source
    let resultCanvas = null;
    let scanner = null;

    const openCameraBtn = document.getElementById('openCamera');
    const captureBtn = document.getElementById('capture');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const video = document.getElementById('video');
    const sourcePreview = document.getElementById('sourcePreview');
    const sourceInfo = document.getElementById('sourceInfo');
    const resultWrap = document.getElementById('resultWrap');
    const resultPlaceholder = document.getElementById('resultPlaceholder');

    // Initialize scanner when jscanify is available
    function ensureScannerReady(){
      if(window.jscanify){
        try{
          scanner = new jscanify();
          console.log('jscanify ready');
        }catch(e){
          console.error('Failed to create scanner', e);
        }
      } else {
        console.log('jscanify not yet loaded, retrying...');
        setTimeout(ensureScannerReady, 300);
      }
    }
    ensureScannerReady();

    // Open user camera
    openCameraBtn.addEventListener('click', async ()=>{
      if(videoStream){ // already open -> close
        stopCamera();
        return;
      }
      try{
        videoStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
        video.srcObject = videoStream;
        video.style.display = 'block';
        sourcePreview.style.display = 'none';
        captureBtn.disabled = false;
        sourceInfo.textContent = 'Camera active';
        openCameraBtn.textContent = 'Close Camera';
      }catch(err){
        console.error(err);
        alert('Could not open camera. Make sure you granted permission.');
      }
    });

    function stopCamera(){
      if(videoStream){
        videoStream.getTracks().forEach(t=>t.stop());
        videoStream = null;
      }
      video.srcObject = null;
      video.style.display = 'none';
      captureBtn.disabled = true;
      openCameraBtn.textContent = 'Open Camera';
      sourceInfo.textContent = 'No source selected';
    }

    // Capture from video to an image element
    captureBtn.addEventListener('click', ()=>{
      if(!videoStream) return;
      const w = video.videoWidth;
      const h = video.videoHeight;
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      const ctx = c.getContext('2d');
      ctx.drawImage(video,0,0,w,h);
      const dataUrl = c.toDataURL('image/jpeg');
      loadImageFromDataUrl(dataUrl, 'captured.jpg');
    });

    // Upload file
    uploadBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> loadImageFromDataUrl(reader.result, f.name);
      reader.readAsDataURL(f);
    });

    function loadImageFromDataUrl(dataUrl, name){
      // cleanup previous
      clearResult();
      stopCamera();
      const img = new Image();
      img.onload = ()=>{
        currentImage = img;
        sourcePreview.src = dataUrl;
        sourcePreview.style.display = 'block';
        sourceInfo.textContent = `Source: ${name} — ${img.naturalWidth}×${img.naturalHeight}`;
        processBtn.disabled = false;
      };
      img.onerror = ()=>{alert('Failed to load image');};
      img.src = dataUrl;
    }

    // Process (use jscanify.extractPaper)
    processBtn.addEventListener('click', ()=>{
      if(!scanner){
        alert('Scanner not ready yet — please wait a moment.');
        return;
      }
      if(!currentImage){
        alert('No image source. Capture or upload one.');
        return;
      }

      // Choose output size based on source orientation
      const paperWidth = 1200; // px - adjust as needed
      const paperHeight = Math.round(paperWidth * 1.414); // A4-ish ratio (approx)

      try{
        // scanner.extractPaper returns a canvas element
        const resCanvas = scanner.extractPaper(currentImage, paperWidth, paperHeight);
        if(!resCanvas){
          alert('Failed to extract paper.');
          return;
        }
        showResultCanvas(resCanvas);
      }catch(err){
        console.error(err);
        alert('Error while processing: ' + (err.message||err));
      }
    });

    function showResultCanvas(c){
      clearResult();
      resultCanvas = c;
      resultCanvas.style.maxHeight = '520px';
      resultWrap.appendChild(resultCanvas);
      resultPlaceholder.style.display = 'none';
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'Download Result';
    }

    function clearResult(){
      resultWrap.querySelectorAll('canvas').forEach(n=>n.remove());
      resultCanvas = null;
      resultPlaceholder.style.display = 'block';
      downloadBtn.disabled = true;
      downloadBtn.textContent = 'Download Result';
    }

    downloadBtn.addEventListener('click', ()=>{
      if(!resultCanvas) return;
      const link = document.createElement('a');
      link.download = 'scanned-document.png';
      link.href = resultCanvas.toDataURL('image/png');
      link.click();
    });

    resetBtn.addEventListener('click', ()=>{
      stopCamera();
      currentImage = null;
      sourcePreview.src = '';
      sourcePreview.style.display = 'none';
      sourceInfo.textContent = 'No source selected';
      processBtn.disabled = true;
      clearResult();
    });

    // cleanup when leaving
    window.addEventListener('beforeunload', ()=>{
      stopCamera();
    });
  </script>
</body>
</html>
