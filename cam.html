<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Enhanced jscanify Document Scanner Demo</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        h2 {
            color: #4a5568;
            border-left: 4px solid #667eea;
            padding-left: 16px;
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
            border: 1px solid #e9ecef;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .file-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        canvas,
        video {
            display: block;
            margin: 20px auto;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            max-width: 100%;
            height: auto;
            background: #000;
        }

        #highlightCanvas {
            position: relative;
            z-index: 2;
        }

        #video {
            position: absolute;
            z-index: 1;
            opacity: 0.3;
        }

        .camera-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px auto;
        }

        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 16px;
            margin: 20px 0;
            white-space: pre-wrap;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            overflow-x: auto;
        }

        button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 4px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(40, 167, 69, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.camera-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        button.camera-btn:hover {
            box-shadow: 0 8px 24px rgba(0, 123, 255, 0.4);
        }

        button.stop-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        button.capture-btn {
            background: linear-gradient(135deg, #fd7e14, #e55100);
            box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3);
        }

        #cameraContainer {
            text-align: center;
        }

        .detection-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .detection-status.detected {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 2px solid #28a745;
        }

        .detection-status.no-detection {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
        }

        .scan-preview {
            margin: 20px 0;
            text-align: center;
        }

        .scan-preview canvas {
            border: 3px solid #28a745;
            box-shadow: 0 8px 32px rgba(40, 167, 69, 0.2);
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        .stats {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fps-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            canvas, video {
                max-width: calc(100vw - 60px);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìÑ Enhanced Document Scanner</h1>

        <!-- SCAN FROM FILE -->
        <div class="section">
            <h2>üìÅ Scan From File</h2>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept="image/*" />
                üì∑ Choose Image File
            </div>
            <div id="uploadPreview"></div>
        </div>

        <!-- LIVE DETECTION -->
        <div class="section">
            <h2>üìπ Live Document Detection</h2>
            <div class="controls">
                <button id="startCameraBtn" class="camera-btn">üé• Start Camera</button>
                <div class="detection-status no-detection" id="detectionStatus">
                    üìÑ No document detected
                </div>
            </div>
            
            <div id="cameraContainer" style="display:none;">
                <div class="camera-wrapper">
                    <video id="video" autoplay playsinline muted></video>
                    <canvas id="highlightCanvas"></canvas>
                    <div class="fps-counter" id="fpsCounter">0 FPS</div>
                </div>
                
                <div class="controls">
                    <button id="captureBtn" class="capture-btn">üì∏ Capture Document</button>
                    <button id="stopCameraBtn" class="stop-btn">‚èπÔ∏è Stop Camera</button>
                </div>
                
                <div class="stats" id="detectionStats" style="display:none;">
                    <strong>Detection Stats:</strong>
                    <div>Confidence: <span id="confidence">0%</span></div>
                    <div>Contours Found: <span id="contoursCount">0</span></div>
                    <div>Processing Time: <span id="processingTime">0ms</span></div>
                </div>
                
                <div id="cameraResult"></div>
            </div>
        </div>
    </div>

    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ColonelParrot/jscanify@master/src/jscanify.min.js"></script>

    <script>
        class EnhancedDocumentScanner {
            constructor() {
                this.scanner = null;
                this.stream = null;
                this.highlightInterval = null;
                this.isProcessing = false;
                this.detectionBuffer = [];
                this.bufferSize = 5;
                this.lastProcessTime = 0;
                this.frameCount = 0;
                this.lastFpsTime = Date.now();
                this.currentFps = 0;
                
                this.init();
            }

            async init() {
                // Wait for jscanify to load
                while (!window.jscanify) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                this.scanner = new jscanify();
                this.setupEventListeners();
            }

            setupEventListeners() {
                const fileInput = document.getElementById("fileInput");
                const startCameraBtn = document.getElementById("startCameraBtn");
                const stopCameraBtn = document.getElementById("stopCameraBtn");
                const captureBtn = document.getElementById("captureBtn");

                fileInput.addEventListener("change", (e) => this.handleFileUpload(e));
                startCameraBtn.addEventListener("click", () => this.startCamera());
                stopCameraBtn.addEventListener("click", () => this.stopCamera());
                captureBtn.addEventListener("click", () => this.captureDocument());
            }

            async handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const uploadPreview = document.getElementById("uploadPreview");
                uploadPreview.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading"></div>Processing image...</div>';

                const img = new Image();
                img.onload = () => {
                    uploadPreview.innerHTML = "";
                    this.processStaticImage(img, uploadPreview);
                };
                img.src = URL.createObjectURL(file);
            }

            processStaticImage(img, container) {
                try {
                    // Create a wrapper div
                    const wrapper = document.createElement('div');
                    wrapper.style.textAlign = 'center';

                    // Highlighting with better visualization
                    const highlighted = this.scanner.highlightPaper(img);
                    highlighted.style.maxWidth = '400px';
                    highlighted.style.margin = '10px';
                    
                    const hlLabel = document.createElement('p');
                    hlLabel.textContent = 'üîç Document Detection';
                    hlLabel.style.fontWeight = 'bold';
                    hlLabel.style.marginBottom = '5px';
                    
                    wrapper.appendChild(hlLabel);
                    wrapper.appendChild(highlighted);

                    // Extracting with enhanced quality
                    const scanned = this.scanner.extractPaper(img, 600, 800);
                    scanned.style.maxWidth = '400px';
                    scanned.style.margin = '10px';
                    
                    const scanLabel = document.createElement('p');
                    scanLabel.textContent = '‚ú® Scanned Result';
                    scanLabel.style.fontWeight = 'bold';
                    scanLabel.style.marginBottom = '5px';
                    
                    wrapper.appendChild(scanLabel);
                    wrapper.appendChild(scanned);

                    // Enhanced save button
                    const saveBtn = document.createElement("button");
                    saveBtn.innerHTML = "üíæ Download High-Quality Scan";
                    saveBtn.addEventListener("click", () => {
                        // Create high-resolution scan
                        const highResScan = this.scanner.extractPaper(img, 1200, 1600);
                        const dataUrl = highResScan.toDataURL("image/jpeg", 0.95);
                        const a = document.createElement("a");
                        a.href = dataUrl;
                        a.download = `scanned_document_${Date.now()}.jpg`;
                        a.click();
                    });
                    wrapper.appendChild(saveBtn);

                    // Corner detection info with styling
                    const mat = cv.imread(img);
                    const contour = this.scanner.findPaperContour(mat);
                    
                    if (contour) {
                        const corners = this.scanner.getCornerPoints(contour);
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'stats';
                        infoDiv.innerHTML = `
                            <strong>üìä Detection Analysis:</strong>
                            <pre>${JSON.stringify({
                                corners: corners,
                                imageSize: { width: img.width, height: img.height },
                                confidence: "High",
                                timestamp: new Date().toLocaleString()
                            }, null, 2)}</pre>
                        `;
                        wrapper.appendChild(infoDiv);
                    }

                    mat.delete();
                    container.appendChild(wrapper);

                } catch (error) {
                    console.error('Error processing image:', error);
                    container.innerHTML = `<div style="color:red;text-align:center;padding:20px;">‚ùå Error processing image: ${error.message}</div>`;
                }
            }

            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: "environment",
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        } 
                    });
                    
                    const video = document.getElementById("video");
                    const cameraContainer = document.getElementById("cameraContainer");
                    
                    video.srcObject = this.stream;
                    await video.play();
                    
                    cameraContainer.style.display = "block";
                    document.getElementById("startCameraBtn").style.display = "none";

                    this.setupCanvasAndStartDetection();
                    
                } catch (err) {
                    alert("‚ùå Error accessing camera: " + err.message);
                }
            }

            setupCanvasAndStartDetection() {
                const video = document.getElementById("video");
                const highlightCanvas = document.getElementById("highlightCanvas");
                const ctx = highlightCanvas.getContext("2d");

                // Wait for video metadata
                video.addEventListener('loadedmetadata', () => {
                    highlightCanvas.width = video.videoWidth;
                    highlightCanvas.height = video.videoHeight;
                    
                    // Start detection with stable algorithm
                    this.startStableDetection(video, ctx);
                });
            }

            startStableDetection(video, ctx) {
                const detectFrame = () => {
                    if (!this.stream || this.isProcessing) {
                        requestAnimationFrame(detectFrame);
                        return;
                    }

                    this.isProcessing = true;
                    const startTime = performance.now();

                    try {
                        // Clear canvas
                        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                        
                        // Draw current video frame
                        ctx.drawImage(video, 0, 0);
                        
                        // Create temporary canvas for detection
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = ctx.canvas.width;
                        tempCanvas.height = ctx.canvas.height;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.drawImage(video, 0, 0);
                        
                        // Perform detection on temp canvas
                        const highlighted = this.scanner.highlightPaper(tempCanvas);
                        
                        // Draw stable result
                        this.drawStabilizedHighlight(ctx, highlighted, tempCanvas);
                        
                        // Update stats
                        const processingTime = performance.now() - startTime;
                        this.updateDetectionStats(processingTime);
                        
                    } catch (error) {
                        console.error('Detection error:', error);
                    }

                    this.isProcessing = false;
                    this.updateFPS();
                    
                    if (this.stream) {
                        requestAnimationFrame(detectFrame);
                    }
                };

                requestAnimationFrame(detectFrame);
            }

            drawStabilizedHighlight(ctx, highlighted, originalCanvas) {
                try {
                    // Extract detection data
                    const mat = cv.imread(originalCanvas);
                    const contour = this.scanner.findPaperContour(mat);
                    
                    if (contour && contour.size() > 0) {
                        const corners = this.scanner.getCornerPoints(contour);
                        
                        // Add to buffer for stabilization
                        this.detectionBuffer.push(corners);
                        if (this.detectionBuffer.length > this.bufferSize) {
                            this.detectionBuffer.shift();
                        }
                        
                        // Calculate stabilized corners
                        const stabilizedCorners = this.getStabilizedCorners();
                        
                        if (stabilizedCorners) {
                            this.drawStableOutline(ctx, stabilizedCorners);
                            this.updateDetectionStatus(true, this.calculateConfidence(corners));
                        } else {
                            this.updateDetectionStatus(false, 0);
                        }
                    } else {
                        this.updateDetectionStatus(false, 0);
                    }
                    
                    mat.delete();
                    if (contour) contour.delete();
                    
                } catch (error) {
                    console.error('Stabilization error:', error);
                    this.updateDetectionStatus(false, 0);
                }
            }

            getStabilizedCorners() {
                if (this.detectionBuffer.length < 3) return null;
                
                // Average the corner positions for stability
                const avgCorners = { topLeft: {x:0,y:0}, topRight: {x:0,y:0}, bottomLeft: {x:0,y:0}, bottomRight: {x:0,y:0} };
                const validBuffers = this.detectionBuffer.filter(corners => corners && corners.topLeft);
                
                if (validBuffers.length === 0) return null;
                
                validBuffers.forEach(corners => {
                    avgCorners.topLeft.x += corners.topLeft.x;
                    avgCorners.topLeft.y += corners.topLeft.y;
                    avgCorners.topRight.x += corners.topRight.x;
                    avgCorners.topRight.y += corners.topRight.y;
                    avgCorners.bottomLeft.x += corners.bottomLeft.x;
                    avgCorners.bottomLeft.y += corners.bottomLeft.y;
                    avgCorners.bottomRight.x += corners.bottomRight.x;
                    avgCorners.bottomRight.y += corners.bottomRight.y;
                });
                
                const count = validBuffers.length;
                Object.keys(avgCorners).forEach(key => {
                    avgCorners[key].x /= count;
                    avgCorners[key].y /= count;
                });
                
                return avgCorners;
            }

            drawStableOutline(ctx, corners) {
                ctx.strokeStyle = '#28a745';
                ctx.lineWidth = 4;
                ctx.setLineDash([]);
                ctx.shadowColor = 'rgba(40, 167, 69, 0.5)';
                ctx.shadowBlur = 8;
                
                ctx.beginPath();
                ctx.moveTo(corners.topLeft.x, corners.topLeft.y);
                ctx.lineTo(corners.topRight.x, corners.topRight.y);
                ctx.lineTo(corners.bottomRight.x, corners.bottomRight.y);
                ctx.lineTo(corners.bottomLeft.x, corners.bottomLeft.y);
                ctx.closePath();
                ctx.stroke();
                
                // Draw corner circles
                ctx.fillStyle = '#28a745';
                ctx.shadowBlur = 0;
                Object.values(corners).forEach(corner => {
                    ctx.beginPath();
                    ctx.arc(corner.x, corner.y, 8, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }

            updateDetectionStatus(detected, confidence) {
                const status = document.getElementById('detectionStatus');
                const statsDiv = document.getElementById('detectionStats');
                
                if (detected) {
                    status.className = 'detection-status detected';
                    status.textContent = `‚úÖ Document Detected (${Math.round(confidence)}% confidence)`;
                    statsDiv.style.display = 'block';
                    document.getElementById('confidence').textContent = `${Math.round(confidence)}%`;
                } else {
                    status.className = 'detection-status no-detection';
                    status.textContent = 'üìÑ Position document in frame';
                    statsDiv.style.display = 'none';
                }
            }

            calculateConfidence(corners) {
                if (!corners || !corners.topLeft) return 0;
                
                // Simple confidence calculation based on corner distribution
                const area = this.calculateQuadrilateralArea(corners);
                const canvasArea = document.getElementById('highlightCanvas').width * document.getElementById('highlightCanvas').height;
                const areaRatio = area / canvasArea;
                
                return Math.min(100, Math.max(0, areaRatio * 300)); // Scale to 0-100%
            }

            calculateQuadrilateralArea(corners) {
                // Shoelace formula for quadrilateral area
                const points = [corners.topLeft, corners.topRight, corners.bottomRight, corners.bottomLeft];
                let area = 0;
                for (let i = 0; i < points.length; i++) {
                    const j = (i + 1) % points.length;
                    area += points[i].x * points[j].y;
                    area -= points[j].x * points[i].y;
                }
                return Math.abs(area) / 2;
            }

            updateDetectionStats(processingTime) {
                document.getElementById('processingTime').textContent = `${Math.round(processingTime)}ms`;
                document.getElementById('contoursCount').textContent = this.detectionBuffer.length;
            }

            updateFPS() {
                this.frameCount++;
                const now = Date.now();
                if (now - this.lastFpsTime >= 1000) {
                    this.currentFps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFpsTime = now;
                    document.getElementById('fpsCounter').textContent = `${this.currentFps} FPS`;
                }
            }

            captureDocument() {
                if (!this.stream) return;

                const highlightCanvas = document.getElementById('highlightCanvas');
                const cameraResult = document.getElementById('cameraResult');
                
                cameraResult.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading"></div>Processing capture...</div>';

                setTimeout(() => {
                    try {
                        const scan = this.scanner.extractPaper(highlightCanvas, 800, 1000);
                        
                        const wrapper = document.createElement('div');
                        wrapper.className = 'scan-preview';
                        
                        const title = document.createElement('h3');
                        title.textContent = 'üì∏ Captured Document';
                        title.style.color = '#28a745';
                        
                        wrapper.appendChild(title);
                        wrapper.appendChild(scan);

                        // Enhanced save options
                        const saveHighRes = document.createElement("button");
                        saveHighRes.innerHTML = "üíæ Save High Resolution";
                        saveHighRes.addEventListener("click", () => {
                            const highRes = this.scanner.extractPaper(highlightCanvas, 1200, 1600);
                            const dataUrl = highRes.toDataURL("image/jpeg", 0.95);
                            const a = document.createElement("a");
                            a.href = dataUrl;
                            a.download = `scan_${Date.now()}.jpg`;
                            a.click();
                        });

                        const savePDF = document.createElement("button");
                        savePDF.innerHTML = "üìÑ Save as PDF";
                        savePDF.style.background = "linear-gradient(135deg, #dc3545, #c82333)";
                        savePDF.addEventListener("click", () => {
                            // Basic PDF creation (you might want to use jsPDF library for better results)
                            alert("PDF export feature - integrate jsPDF library for full functionality");
                        });

                        wrapper.appendChild(saveHighRes);
                        wrapper.appendChild(savePDF);

                        // Analysis info
                        const analysis = document.createElement('div');
                        analysis.className = 'stats';
                        const stabilizedCorners = this.getStabilizedCorners();
                        analysis.innerHTML = `
                            <strong>üìä Scan Analysis:</strong>
                            <div>Resolution: ${scan.width} √ó ${scan.height} pixels</div>
                            <div>Confidence: ${stabilizedCorners ? Math.round(this.calculateConfidence(stabilizedCorners)) : 0}%</div>
                            <div>Processing FPS: ${this.currentFps}</div>
                            <div>Timestamp: ${new Date().toLocaleString()}</div>
                        `;
                        wrapper.appendChild(analysis);

                        cameraResult.innerHTML = '';
                        cameraResult.appendChild(wrapper);

                    } catch (error) {
                        console.error('Capture error:', error);
                        cameraResult.innerHTML = `<div style="color:red;text-align:center;padding:20px;">‚ùå Capture failed: ${error.message}</div>`;
                    }
                }, 100);
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                document.getElementById("cameraContainer").style.display = "none";
                document.getElementById("startCameraBtn").style.display = "block";
                this.detectionBuffer = [];
            }
        }

        // Initialize when everything is loaded
        window.addEventListener("load", () => {
            new EnhancedDocumentScanner();
        });
    </script>
</body>

</html>
